<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LaPelota - GestÃ£o de Peladas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --bg-dark: #0a0f1a;
            --bg-card: #111827;
            --bg-elevated: #1f2937;
            --border-color: #374151;
        }
        
        body { 
            font-family: 'Outfit', sans-serif; 
            overflow: hidden;
            background: var(--bg-dark);
        }
        
        .draggable-item { cursor: grab; touch-action: none; }
        .draggable-item:active { cursor: grabbing; }
        .font-mono-nums { font-variant-numeric: tabular-nums; }
        
        /* Scrollbar elegante */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        
        .drag-over-item { border-top: 2px solid #34d399 !important; }
        
        /* Gradiente animado para login */
        .gradient-bg {
            background: linear-gradient(135deg, #0a0f1a 0%, #1a1f2e 50%, #0f172a 100%);
            position: relative;
            overflow: hidden;
        }
        
        .gradient-bg::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(16, 185, 129, 0.1) 0%, transparent 50%);
            animation: pulse-glow 8s ease-in-out infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        /* Sidebar */
        .sidebar {
            transition: width 0.3s ease;
        }
        
        .sidebar.collapsed {
            width: 64px;
        }
        
        .sidebar.expanded {
            width: 240px;
        }
        
        .sidebar-item {
            transition: all 0.2s ease;
        }
        
        .sidebar-item:hover {
            background: rgba(16, 185, 129, 0.1);
        }
        
        .sidebar-item.active {
            background: rgba(16, 185, 129, 0.15);
            border-left: 3px solid #10b981;
        }
        
        /* Cards com hover */
        .card-hover {
            transition: all 0.2s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.3);
        }
        
        /* Modal backdrop */
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }
        
        /* Input focus */
        .input-focus:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }
        
        /* Button primary */
        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        /* Avatar placeholder */
        .avatar-placeholder {
            background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
        }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 h-screen w-screen flex flex-col text-sm overflow-hidden">

<div id="app" class="h-full w-full">
    
    <!-- ==================== TELA DE LOGIN ==================== -->
    <div v-if="!session" class="gradient-bg h-full w-full flex items-center justify-center p-4">
        <div class="relative z-10 w-full max-w-md">
            <!-- Logo -->
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-20 h-20 rounded-2xl bg-gradient-to-br from-emerald-500 to-emerald-700 shadow-lg shadow-emerald-500/30 mb-4">
                    <i class="ph ph-soccer-ball text-4xl text-white"></i>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">LaPelota</h1>
                <p class="text-gray-400">GestÃ£o inteligente de peladas</p>
            </div>
            
            <!-- Card de Login -->
            <div class="bg-gray-900/80 backdrop-blur-sm rounded-2xl border border-gray-800 p-8 shadow-2xl">
                <!-- Tabs -->
                <div class="flex mb-6 bg-gray-800 rounded-lg p-1">
                    <button 
                        @click="authMode = 'login'" 
                        class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition"
                        :class="authMode === 'login' ? 'bg-emerald-600 text-white' : 'text-gray-400 hover:text-white'"
                    >
                        Entrar
                    </button>
                    <button 
                        @click="authMode = 'signup'" 
                        class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition"
                        :class="authMode === 'signup' ? 'bg-emerald-600 text-white' : 'text-gray-400 hover:text-white'"
                    >
                        Criar conta
                    </button>
                </div>
                
                <!-- FormulÃ¡rio -->
                <form @submit.prevent="handleAuth" class="space-y-4">
                    <div v-if="authMode === 'signup'">
                        <label class="block text-sm font-medium text-gray-300 mb-1">Nome completo</label>
                        <input 
                            v-model="authForm.fullName" 
                            type="text" 
                            placeholder="Seu nome"
                            class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 input-focus"
                        >
                    </div>
                    
        <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">E-mail</label>
                        <input 
                            v-model="authForm.email" 
                            type="email" 
                            placeholder="seu@email.com"
                            required
                            class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 input-focus"
                        >
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Senha</label>
                        <input 
                            v-model="authForm.password" 
                            type="password" 
                            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                            required
                            minlength="6"
                            class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 input-focus"
                        >
                    </div>
                    
                    <div v-if="authError" class="bg-red-900/50 border border-red-700 rounded-lg p-3 text-red-300 text-sm">
                        {{ authError }}
                    </div>
                    
                    <div v-if="authSuccess" class="bg-emerald-900/50 border border-emerald-700 rounded-lg p-3 text-emerald-300 text-sm">
                        {{ authSuccess }}
                    </div>
                    
                    <button 
                        type="submit" 
                        :disabled="authLoading"
                        class="w-full btn-primary text-white font-semibold py-3 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <span v-if="authLoading" class="flex items-center justify-center gap-2">
                            <i class="ph ph-spinner animate-spin"></i> Aguarde...
                        </span>
                        <span v-else>{{ authMode === 'login' ? 'Entrar' : 'Criar conta' }}</span>
                    </button>
                </form>
            </div>
            
            <!-- Footer -->
            <p class="text-center text-gray-500 text-sm mt-6">
                Â© 2024 LaPelota. Organize suas peladas com facilidade.
            </p>
        </div>
    </div>
    
    <!-- ==================== INTRANET (PÃ“S-LOGIN) ==================== -->
    <div v-else class="h-full w-full flex">
        
        <!-- Sidebar -->
        <aside 
            class="sidebar bg-gray-900 border-r border-gray-800 flex flex-col h-full"
            :class="sidebarExpanded ? 'expanded' : 'collapsed'"
        >
            <!-- Header da Sidebar -->
            <div class="p-4 border-b border-gray-800 flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-emerald-500 to-emerald-700 flex items-center justify-center flex-shrink-0">
                    <i class="ph ph-soccer-ball text-xl text-white"></i>
                </div>
                <span v-show="sidebarExpanded" class="font-bold text-lg text-white whitespace-nowrap">LaPelota</span>
            </div>
            
            <!-- Menu -->
            <nav class="flex-1 p-2 space-y-1">
                <button 
                    @click="navigateTo('grupos')"
                    class="sidebar-item w-full flex items-center gap-3 px-3 py-3 rounded-lg text-left"
                    :class="currentView === 'grupos' || currentView === 'pelada' ? 'active text-emerald-400' : 'text-gray-400 hover:text-white'"
                >
                    <i class="ph ph-users-three text-xl flex-shrink-0"></i>
                    <span v-show="sidebarExpanded" class="whitespace-nowrap">Grupos</span>
                </button>
                
                <button 
                    @click="navigateTo('config')"
                    class="sidebar-item w-full flex items-center gap-3 px-3 py-3 rounded-lg text-left"
                    :class="currentView === 'config' ? 'active text-emerald-400' : 'text-gray-400 hover:text-white'"
                >
                    <i class="ph ph-gear text-xl flex-shrink-0"></i>
                    <span v-show="sidebarExpanded" class="whitespace-nowrap">ConfiguraÃ§Ãµes</span>
                </button>
            </nav>
            
            <!-- Footer da Sidebar -->
            <div class="p-2 border-t border-gray-800">
                <!-- Toggle Sidebar -->
                <button 
                    @click="sidebarExpanded = !sidebarExpanded"
                    class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-gray-400 hover:text-white hover:bg-gray-800 transition mb-2"
                >
                    <i class="ph text-xl flex-shrink-0" :class="sidebarExpanded ? 'ph-caret-left' : 'ph-caret-right'"></i>
                    <span v-show="sidebarExpanded" class="whitespace-nowrap text-sm">Recolher</span>
                </button>
                
                <!-- UsuÃ¡rio -->
                <div class="flex items-center gap-3 px-3 py-2">
                    <div class="w-8 h-8 rounded-full avatar-placeholder flex items-center justify-center flex-shrink-0 overflow-hidden">
                        <img v-if="userProfile?.foto_do_jogador" :src="userProfile.foto_do_jogador" class="w-full h-full object-cover">
                        <i v-else class="ph ph-user text-gray-400"></i>
                    </div>
                    <div v-show="sidebarExpanded" class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-white truncate">{{ userProfile?.apelido_do_jogador || userProfile?.nome_do_jogador || 'UsuÃ¡rio' }}</p>
                        <p class="text-xs text-gray-500 truncate">{{ session?.user?.email }}</p>
                    </div>
                </div>
                
                <!-- Logout -->
                <button 
                    @click="handleLogout"
                    class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-red-400 hover:text-red-300 hover:bg-red-900/20 transition"
                >
                    <i class="ph ph-sign-out text-xl flex-shrink-0"></i>
                    <span v-show="sidebarExpanded" class="whitespace-nowrap text-sm">Sair</span>
                </button>
            </div>
        </aside>
        
        <!-- ConteÃºdo Principal -->
        <main class="flex-1 h-full overflow-hidden bg-gray-950">
            
            <!-- ==================== VIEW: GRUPOS ==================== -->
            <div v-if="currentView === 'grupos'" class="h-full flex flex-col p-6 overflow-hidden">
                <header class="flex-shrink-0 mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-2xl font-bold text-white">Meus Grupos</h1>
                            <p class="text-gray-400">Gerencie seus grupos de pelada</p>
                        </div>
                        <button 
                            @click="openCreateGroupModal"
                            class="btn-primary px-4 py-2 rounded-lg font-medium flex items-center gap-2"
                        >
                            <i class="ph ph-plus"></i>
                            Criar grupo
                        </button>
                    </div>
                </header>
                
                <div class="flex-1 overflow-y-auto space-y-8 pr-2">
                    
                    <!-- Convites Pendentes -->
                    <section v-if="pendingInvites.length > 0">
                        <h2 class="text-lg font-semibold text-yellow-400 mb-4 flex items-center gap-2">
                            <i class="ph ph-envelope-simple"></i>
                            Convites Pendentes
                            <span class="bg-yellow-500/20 text-yellow-400 text-xs px-2 py-0.5 rounded-full">{{ pendingInvites.length }}</span>
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div 
                                v-for="invite in pendingInvites" 
                                :key="invite.grupo_id"
                                class="bg-gray-900 border border-yellow-600/30 rounded-xl p-4 card-hover"
                            >
                                <div class="flex items-start justify-between mb-3">
                                    <div class="flex items-center gap-3">
                                        <div class="w-12 h-12 rounded-xl bg-yellow-600/20 flex items-center justify-center">
                                            <i class="ph ph-users-three text-2xl text-yellow-400"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-semibold text-white">{{ invite.grupos?.nome_do_grupo }}</h3>
                                            <p class="text-sm text-gray-400">{{ invite.grupos?.cidade_do_grupo }}<span v-if="invite.grupos?.estado_do_grupo">, {{ invite.grupos?.estado_do_grupo }}</span></p>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button 
                                        @click="acceptInvite(invite)"
                                        class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white py-2 rounded-lg font-medium transition"
                                    >
                                        Aceitar
                                    </button>
                                    <button 
                                        @click="declineInvite(invite)"
                                        class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg font-medium transition"
                                    >
                                        Recusar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </section>
                    
                    <!-- Grupos que Coordeno -->
                    <section v-if="adminGroups.length > 0">
                        <h2 class="text-lg font-semibold text-emerald-400 mb-4 flex items-center gap-2">
                            <i class="ph ph-crown"></i>
                            Grupos que Coordeno
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div 
                                v-for="group in adminGroups" 
                                :key="group.grupos?.id"
                                class="bg-gray-900 border border-emerald-600/30 rounded-xl p-4 card-hover"
                            >
                                <div class="flex items-start justify-between mb-4">
                                    <div class="flex items-center gap-3">
                                        <div class="w-12 h-12 rounded-xl bg-emerald-600/20 flex items-center justify-center">
                                            <i class="ph ph-users-three text-2xl text-emerald-400"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-semibold text-white">{{ group.grupos?.nome_do_grupo }}</h3>
                                            <p class="text-sm text-gray-400">{{ group.grupos?.cidade_do_grupo }}<span v-if="group.grupos?.estado_do_grupo">, {{ group.grupos?.estado_do_grupo }}</span></p>
                                        </div>
                                    </div>
                                    <span class="bg-emerald-500/20 text-emerald-400 text-xs px-2 py-1 rounded-full">
                                        {{ group.is_admin ? 'Admin' : 'ResponsÃ¡vel' }}
                                    </span>
                                </div>
                                <div class="flex gap-2">
                                    <button 
                                        @click="openPelada(group.grupos?.id)"
                                        class="flex-1 btn-primary py-2 rounded-lg font-medium flex items-center justify-center gap-2"
                                    >
                                        <i class="ph ph-soccer-ball"></i>
                                        Gerenciar Pelada
                                    </button>
                                    <button 
                                        @click="openMembersModal(group.grupos)"
                                        class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition"
                                        title="Gerenciar Membros"
                                    >
                                        <i class="ph ph-user-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </section>
                    
                    <!-- Meus Grupos (Membro) -->
                    <section v-if="memberGroups.length > 0">
                        <h2 class="text-lg font-semibold text-blue-400 mb-4 flex items-center gap-2">
                            <i class="ph ph-users"></i>
                            Meus Grupos
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div 
                                v-for="group in memberGroups" 
                                :key="group.grupos?.id"
                                class="bg-gray-900 border border-blue-600/30 rounded-xl p-4 card-hover"
                            >
                                <div class="flex items-start justify-between mb-4">
                                    <div class="flex items-center gap-3">
                                        <div class="w-12 h-12 rounded-xl bg-blue-600/20 flex items-center justify-center">
                                            <i class="ph ph-users-three text-2xl text-blue-400"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-semibold text-white">{{ group.grupos?.nome_do_grupo }}</h3>
                                            <p class="text-sm text-gray-400">{{ group.grupos?.cidade_do_grupo }}<span v-if="group.grupos?.estado_do_grupo">, {{ group.grupos?.estado_do_grupo }}</span></p>
                                        </div>
                                    </div>
                                    <span class="bg-blue-500/20 text-blue-400 text-xs px-2 py-1 rounded-full">
                                        Membro
                                    </span>
                                </div>
                                <p class="text-sm text-gray-500">VocÃª Ã© membro deste grupo.</p>
                            </div>
                        </div>
                    </section>
                    
                    <!-- Estado vazio -->
                    <div v-if="pendingInvites.length === 0 && adminGroups.length === 0 && memberGroups.length === 0 && !loadingGroups" class="flex flex-col items-center justify-center py-20">
                        <div class="w-24 h-24 rounded-full bg-gray-800 flex items-center justify-center mb-6">
                            <i class="ph ph-users-three text-5xl text-gray-600"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-400 mb-2">Nenhum grupo ainda</h3>
                        <p class="text-gray-500 mb-6">Crie seu primeiro grupo ou aguarde um convite.</p>
                        <button 
                            @click="openCreateGroupModal"
                            class="btn-primary px-6 py-3 rounded-lg font-medium flex items-center gap-2"
                        >
                            <i class="ph ph-plus"></i>
                            Criar meu primeiro grupo
                        </button>
                    </div>
                    
                    <!-- Loading -->
                    <div v-if="loadingGroups" class="flex items-center justify-center py-20">
                        <i class="ph ph-spinner animate-spin text-4xl text-emerald-500"></i>
                    </div>
                </div>
            </div>
            
            <!-- ==================== VIEW: CONFIGURAÃ‡Ã•ES ==================== -->
            <div v-if="currentView === 'config'" class="h-full flex flex-col p-6 overflow-hidden">
                <header class="flex-shrink-0 mb-6">
                    <h1 class="text-2xl font-bold text-white">ConfiguraÃ§Ãµes</h1>
                    <p class="text-gray-400">Gerencie seu perfil</p>
                </header>
                
                <div class="flex-1 overflow-y-auto">
                    <div class="max-w-2xl">
                        <div class="bg-gray-900 border border-gray-800 rounded-xl p-6">
                            <h2 class="text-lg font-semibold text-white mb-6 flex items-center gap-2">
                                <i class="ph ph-user"></i>
                                Meu Perfil
                            </h2>
                            
                            <form @submit.prevent="saveProfile" class="space-y-4">
                                <!-- Foto -->
                                <div class="flex items-center gap-4 mb-6">
                                    <div class="w-20 h-20 rounded-full avatar-placeholder flex items-center justify-center overflow-hidden">
                                        <img v-if="profileForm.foto_do_jogador" :src="profileForm.foto_do_jogador" class="w-full h-full object-cover">
                                        <i v-else class="ph ph-user text-3xl text-gray-400"></i>
                                    </div>
                                    <div class="flex-1">
                                        <label class="block text-sm font-medium text-gray-300 mb-1">URL da foto</label>
                                        <input 
                                            v-model="profileForm.foto_do_jogador" 
                                            type="url" 
                                            placeholder="https://exemplo.com/foto.jpg"
                                            class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500 input-focus"
                                        >
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-1">Nome completo</label>
                                        <input 
                                            v-model="profileForm.nome_do_jogador" 
                                            type="text" 
                                            required
                                            class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500 input-focus"
                                        >
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-1">Apelido</label>
                                        <input 
                                            v-model="profileForm.apelido_do_jogador" 
                                            type="text" 
                                            placeholder="Como querem te chamar?"
                                            class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500 input-focus"
                                        >
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">E-mail</label>
                                    <input 
                                        :value="userProfile?.email_do_jogador" 
                                        type="email" 
                                        disabled
                                        class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-2 text-gray-400 cursor-not-allowed"
                                    >
                                    <p class="text-xs text-gray-500 mt-1">O e-mail nÃ£o pode ser alterado.</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Telefone</label>
                                    <input 
                                        v-model="profileForm.numero_telefone" 
                                        type="tel" 
                                        placeholder="(00) 00000-0000"
                                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500 input-focus"
                                    >
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-1">Cidade</label>
                                        <input 
                                            v-model="profileForm.cidade_do_jogador" 
                                            type="text" 
                                            class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500 input-focus"
                                        >
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-1">Estado</label>
                                        <input 
                                            v-model="profileForm.estado_do_jogador" 
                                            type="text" 
                                            placeholder="Ex: SP"
                                            maxlength="2"
                                            class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500 input-focus uppercase"
                                        >
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Sexo</label>
                                    <select 
                                        v-model="profileForm.sexo_do_jogador"
                                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white input-focus"
                                    >
                                        <option value="">NÃ£o informado</option>
                                        <option value="M">Masculino</option>
                                        <option value="F">Feminino</option>
                                        <option value="O">Outro</option>
                                    </select>
                                </div>
                                
                                <div v-if="profileError" class="bg-red-900/50 border border-red-700 rounded-lg p-3 text-red-300 text-sm">
                                    {{ profileError }}
                                </div>
                                
                                <div v-if="profileSuccess" class="bg-emerald-900/50 border border-emerald-700 rounded-lg p-3 text-emerald-300 text-sm">
                                    {{ profileSuccess }}
                                </div>
                                
                                <div class="pt-4">
                                    <button 
                                        type="submit" 
                                        :disabled="savingProfile"
                                        class="btn-primary px-6 py-2 rounded-lg font-medium disabled:opacity-50"
                                    >
                                        <span v-if="savingProfile" class="flex items-center gap-2">
                                            <i class="ph ph-spinner animate-spin"></i> Salvando...
                                        </span>
                                        <span v-else>Salvar alteraÃ§Ãµes</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ==================== VIEW: PELADA ==================== -->
            <div v-if="currentView === 'pelada'" class="h-full flex flex-col">
                <!-- Header da Pelada -->
                <header class="flex-shrink-0 bg-gray-900 border-b border-gray-800 px-4 py-3 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <button 
                            @click="navigateTo('grupos')"
                            class="p-2 hover:bg-gray-800 rounded-lg transition"
                        >
                            <i class="ph ph-arrow-left text-xl"></i>
                        </button>
                        <div>
                            <h1 class="text-lg font-bold text-emerald-400 flex items-center gap-2">
                <i class="ph ph-soccer-ball"></i> GestÃ£o de Pelada
            </h1>
                            <p class="text-xs text-gray-400">{{ currentGroupName }}</p>
                        </div>
        </div>
        
        <div class="flex items-center gap-3">
            <div class="flex items-center gap-1">
                <span class="text-[9px] text-gray-500 uppercase font-bold">Tempo:</span>
                            <span class="font-bold text-emerald-400 text-[10px]">{{ peladaStatus.isFirstMatch ? '10 min' : '7 min' }}</span>
            </div>
                        <button @click="resetPelada" class="text-red-400 hover:text-red-300 text-[10px] uppercase font-bold px-2 border-l border-gray-700">
                Resetar
            </button>
        </div>
    </header>

                <!-- ConteÃºdo da Pelada -->
                <div class="flex-1 p-2 overflow-hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-2 h-full">
        
                        <!-- Coluna Esquerda: Cadastro -->
        <section class="lg:col-span-2 flex flex-col bg-gray-900 rounded-lg border border-gray-800 h-full overflow-hidden">
            <div class="flex-shrink-0 border-b border-gray-800">
                                <div @click="peladaUI.showRegister = !peladaUI.showRegister" class="p-2 bg-gray-800 cursor-pointer flex justify-between items-center hover:bg-gray-750 transition">
                    <h2 class="font-bold text-gray-300 flex items-center gap-1 text-[11px]"><i class="ph ph-users"></i> Cadastro</h2>
                                    <i class="ph text-xs" :class="peladaUI.showRegister ? 'ph-caret-up' : 'ph-caret-down'"></i>
                </div>
                
                                <div v-show="peladaUI.showRegister" class="p-2 space-y-1.5 bg-gray-900">
                                    <textarea v-model="peladaInput.goalkeepers" placeholder="Goleiros..." class="w-full bg-gray-950 border border-gray-700 rounded p-1.5 text-[10px] h-12 focus:ring-1 focus:ring-emerald-500 outline-none resize-none"></textarea>
                                    <textarea v-model="peladaInput.lines" placeholder="Jogadores..." class="w-full bg-gray-950 border border-gray-700 rounded p-1.5 text-[10px] h-16 focus:ring-1 focus:ring-emerald-500 outline-none resize-none"></textarea>
                                    <button @click="addPeladaPlayers" class="w-full bg-emerald-700 hover:bg-emerald-600 text-white font-bold py-1 rounded text-[10px] uppercase tracking-wide transition">Adicionar</button>
                </div>
            </div>

            <div class="px-2 py-1.5 bg-gray-800 border-b border-gray-700 flex justify-between items-center flex-shrink-0">
                                <span class="text-[9px] uppercase font-bold text-gray-500">Total: {{peladaAllPlayers.length}}</span>
                <div class="flex items-center gap-2">
                                    <button @click="markAllPeladaPaid" class="text-emerald-500 hover:text-emerald-400 text-[9px] flex items-center gap-1 font-bold" title="Marcar Todos como Pagos">
                        ðŸ’° Todos Pagos
                    </button>
                                    <button @click="markAllPeladaArrivedAndQueue" class="text-cyan-500 hover:text-cyan-400 text-[9px] flex items-center gap-1 font-bold" title="Enviar Todos Pagos para Fila">
                        âœ… Todos Chegaram
                    </button>
                </div>
            </div>

            <div class="px-1.5 py-1 bg-gray-850 border-b border-gray-700 flex justify-between items-center flex-shrink-0">
                <span class="text-[8px] uppercase font-bold text-gray-500">Jogador</span>
                <div class="flex items-center gap-1">
                                    <span class="text-[8px] uppercase font-bold text-emerald-500 w-6 text-center" :title="peladaPaidCount + ' pagos'">ðŸ’° <span class="text-[7px] text-emerald-400">{{peladaPaidCount}}</span></span>
                                    <span class="text-[8px] uppercase font-bold text-cyan-500 w-6 text-center" :title="peladaArrivedCount + ' chegaram'">âœ… <span class="text-[7px] text-cyan-400">{{peladaArrivedCount}}</span></span>
                </div>
            </div>

                            <div class="flex-1 overflow-y-auto p-1.5 bg-gray-900" @dragover.prevent @drop="onDropOnPeladaRegister($event)">
                <ul class="space-y-1">
                                    <li v-for="(p, idx) in peladaAllPlayers" :key="p.id" 
                        class="flex items-center justify-between bg-gray-800 p-1 rounded border border-gray-700 group hover:border-gray-600 transition draggable-item"
                        draggable="true"
                                        @dragstart="onPeladaDragStartFromRegister($event, p)">
                        <div class="flex items-center gap-1.5 overflow-hidden">
                            <span class="text-[9px] text-gray-500 font-mono w-3 text-right">{{ idx + 1 }}</span>
                            <span class="w-1.5 h-1.5 rounded-full flex-shrink-0" :class="p.role === 'GK' ? 'bg-yellow-500' : 'bg-blue-500'"></span>
                            <span class="text-[10px] font-medium truncate text-gray-300" :class="{'opacity-40': !p.paid || !p.arrived}">{{ p.name }}</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <div class="w-6 flex justify-center">
                                                <input type="checkbox" v-model="p.paid" @change="onPeladaPaidChange(p)" class="w-3 h-3 accent-emerald-500 cursor-pointer rounded-sm" title="Pago">
                            </div>
                            <div class="w-6 flex justify-center">
                                                <input type="checkbox" v-model="p.arrived" @change="onPeladaArrivedChange(p)" class="w-3 h-3 accent-cyan-500 cursor-pointer rounded-sm" title="Chegou">
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </section>

                        <!-- Coluna Central: Times e Placar -->
        <section class="lg:col-span-7 flex flex-col gap-2 h-full min-h-0">
            
                            <!-- Placar -->
            <div class="bg-gray-900 rounded-lg border border-gray-800 shadow relative flex-shrink-0">
                <div class="absolute top-0 left-0 w-full h-0.5 bg-gradient-to-r from-yellow-500 via-gray-500 to-blue-500 opacity-60"></div>
                
                <div class="p-2 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="flex flex-col items-center">
                            <span class="text-[9px] font-bold text-yellow-400 uppercase">Time Amarelo</span>
                            <div class="flex items-center gap-1 bg-black/30 rounded p-0.5 border border-yellow-600/30">
                                                <button @click="adjustPeladaScore('A', -1)" class="w-5 h-5 hover:bg-gray-700 rounded text-gray-400 flex items-center justify-center"><i class="ph ph-minus"></i></button>
                                                <span class="text-lg font-mono-nums font-bold w-6 text-center text-yellow-400">{{ peladaMatch.scoreA }}</span>
                                                <button @click="adjustPeladaScore('A', 1)" class="w-5 h-5 hover:bg-yellow-900/50 rounded text-yellow-400 flex items-center justify-center"><i class="ph ph-plus"></i></button>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col items-center">
                                        <div class="text-3xl font-mono-nums font-bold tracking-widest leading-none" :class="{'text-red-500 animate-pulse': peladaMatch.timeLeft < 60 && peladaMatch.timeLeft > 0, 'text-white': peladaMatch.timeLeft >= 60}">
                                            {{ peladaFormattedTime }}
                        </div>
                        
                        <div class="flex gap-2 mt-1">
                                            <button @click="togglePeladaTimer" class="px-3 py-0.5 rounded-full text-white text-[10px] font-bold uppercase tracking-wider shadow border border-white/10 transition hover:scale-105" :class="peladaMatch.timerRunning ? 'bg-yellow-600' : 'bg-emerald-600'">
                                                {{ peladaMatch.timerRunning ? 'Pausar' : (peladaMatch.hasStarted ? 'Retomar' : 'Iniciar') }}
                            </button>
                                            <button @click="resetPeladaTimer(peladaStatus.isFirstMatch)" class="w-6 h-6 rounded-full bg-gray-800 hover:bg-gray-700 flex items-center justify-center text-gray-400 border border-gray-700" title="Reiniciar Tempo">
                                <i class="ph ph-arrow-counter-clockwise"></i>
                            </button>
                        </div>
                        
                        <div class="flex gap-1 mt-1.5">
                                            <button @click="setPeladaTimeZero" class="px-1.5 py-0.5 rounded bg-gray-700 hover:bg-gray-600 text-white text-[9px] font-bold border border-gray-600 transition" title="Zerar cronÃ´metro">0s</button>
                                            <button @click="adjustPeladaTime(-60)" class="px-1.5 py-0.5 rounded bg-red-900/50 hover:bg-red-800/60 text-red-400 text-[9px] font-bold border border-red-700/50 transition">-1min</button>
                                            <button @click="adjustPeladaTime(-30)" class="px-1.5 py-0.5 rounded bg-red-900/30 hover:bg-red-800/40 text-red-400 text-[9px] font-bold border border-red-700/30 transition">-30s</button>
                                            <button @click="adjustPeladaTime(-10)" class="px-1.5 py-0.5 rounded bg-red-900/20 hover:bg-red-800/30 text-red-400 text-[9px] font-bold border border-red-700/20 transition">-10s</button>
                                            <button @click="adjustPeladaTime(10)" class="px-1.5 py-0.5 rounded bg-emerald-900/20 hover:bg-emerald-800/30 text-emerald-400 text-[9px] font-bold border border-emerald-700/20 transition">+10s</button>
                                            <button @click="adjustPeladaTime(30)" class="px-1.5 py-0.5 rounded bg-emerald-900/30 hover:bg-emerald-800/40 text-emerald-400 text-[9px] font-bold border border-emerald-700/30 transition">+30s</button>
                                            <button @click="adjustPeladaTime(60)" class="px-1.5 py-0.5 rounded bg-emerald-900/50 hover:bg-emerald-800/60 text-emerald-400 text-[9px] font-bold border border-emerald-700/50 transition">+1min</button>
                        </div>
                    </div>

                    <div class="flex items-center gap-3">
                         <div class="flex flex-col items-center">
                            <span class="text-[9px] font-bold text-blue-400 uppercase">Time Azul</span>
                            <div class="flex items-center gap-1 bg-black/30 rounded p-0.5 border border-blue-600/30">
                                                <button @click="adjustPeladaScore('B', -1)" class="w-5 h-5 hover:bg-gray-700 rounded text-gray-400 flex items-center justify-center"><i class="ph ph-minus"></i></button>
                                                <span class="text-lg font-mono-nums font-bold w-6 text-center text-blue-400">{{ peladaMatch.scoreB }}</span>
                                                <button @click="adjustPeladaScore('B', 1)" class="w-5 h-5 hover:bg-blue-900/50 rounded text-blue-400 flex items-center justify-center"><i class="ph ph-plus"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

                            <!-- Times -->
            <div class="grid grid-cols-2 gap-2 flex-1 min-h-0">
                <div class="bg-yellow-950/30 border border-yellow-500/30 rounded-lg flex flex-col shadow-inner overflow-hidden" 
                                     @dragover.prevent @drop="onPeladaDrop($event, 'teamA')">
                    <div class="bg-yellow-900/30 p-1 border-b border-yellow-500/20 text-center flex-shrink-0 flex items-center justify-center gap-1.5">
                                        <i v-if="peladaMatch.lastWinner === 'A'" class="ph ph-crown text-yellow-300 text-sm" title="Vencedor da Ãºltima partida"></i>
                        <span class="text-[9px] font-bold text-yellow-400 uppercase tracking-widest">TIME AMARELO</span>
                                        <i v-if="peladaMatch.lastWinner === 'A'" class="ph ph-crown text-yellow-300 text-sm" title="Vencedor da Ãºltima partida"></i>
                    </div>
                    <div class="p-1.5 flex-1 overflow-y-auto space-y-1">
                                        <pelada-player-card v-for="p in peladaMatch.teamA" :key="p.id" :player="p" @dragstart="onPeladaDragStart($event, p, 'teamA')"></pelada-player-card>
                                        <div v-if="peladaMatch.teamA.length === 0" class="h-full flex items-center justify-center opacity-20 text-[10px] italic border-2 border-dashed border-gray-700 m-2 rounded">
                            Arrastar Jogadores
                        </div>
                    </div>
                </div>

                <div class="bg-blue-950/30 border border-blue-500/30 rounded-lg flex flex-col shadow-inner overflow-hidden"
                                     @dragover.prevent @drop="onPeladaDrop($event, 'teamB')">
                    <div class="bg-blue-900/30 p-1 border-b border-blue-500/20 text-center flex-shrink-0 flex items-center justify-center gap-1.5">
                                        <i v-if="peladaMatch.lastWinner === 'B'" class="ph ph-crown text-blue-300 text-sm" title="Vencedor da Ãºltima partida"></i>
                        <span class="text-[9px] font-bold text-blue-400 uppercase tracking-widest">TIME AZUL</span>
                                        <i v-if="peladaMatch.lastWinner === 'B'" class="ph ph-crown text-blue-300 text-sm" title="Vencedor da Ãºltima partida"></i>
                    </div>
                    <div class="p-1.5 flex-1 overflow-y-auto space-y-1">
                                        <pelada-player-card v-for="p in peladaMatch.teamB" :key="p.id" :player="p" @dragstart="onPeladaDragStart($event, p, 'teamB')"></pelada-player-card>
                                         <div v-if="peladaMatch.teamB.length === 0" class="h-full flex items-center justify-center opacity-20 text-[10px] italic border-2 border-dashed border-gray-700 m-2 rounded">
                            Arrastar Jogadores
                        </div>
                    </div>
                </div>
            </div>

                            <!-- BotÃµes de aÃ§Ã£o -->
            <div class="bg-gray-900 p-2 rounded-lg border border-gray-800 flex-shrink-0">
                <div class="flex gap-2">
                                    <button @click="generatePeladaInitialTeams" :disabled="peladaStatus.teamsGenerated" class="flex-1 bg-purple-700 hover:bg-purple-600 disabled:bg-gray-800 disabled:text-gray-500 disabled:cursor-not-allowed text-white font-bold py-2 rounded shadow flex items-center justify-center gap-1.5 text-[10px] uppercase tracking-wide transition transform active:scale-[0.99]">
                        <i class="ph ph-shuffle text-sm"></i> Sortear Times
                    </button>
                                    <button @click="clearPeladaTeams" class="flex-1 bg-red-700 hover:bg-red-600 text-white font-bold py-2 rounded shadow flex items-center justify-center gap-1.5 text-[10px] uppercase tracking-wide transition transform active:scale-[0.99]">
                        <i class="ph ph-trash text-sm"></i> Limpar TÃ¡bua
                    </button>
                                    <button @click="rotatePeladaTeams" class="flex-1 bg-blue-700 hover:bg-blue-600 text-white font-bold py-2 rounded shadow flex items-center justify-center gap-1.5 text-[10px] uppercase tracking-wide transition transform active:scale-[0.99]">
                        <i class="ph ph-arrows-clockwise text-sm"></i> Rotacionar
                    </button>
                                    <button @click="nextPeladaMatch" class="flex-1 bg-emerald-700 hover:bg-emerald-600 text-white font-bold py-2 rounded shadow flex items-center justify-center gap-1.5 text-[10px] uppercase tracking-wide transition transform active:scale-[0.99]">
                        <i class="ph ph-caret-right text-sm"></i> PrÃ³ximo
                    </button>
                </div>
            </div>
        </section>

                        <!-- Coluna Direita: Filas -->
        <section class="lg:col-span-3 flex flex-col gap-2 h-full min-h-0 overflow-hidden">
            
                            <!-- Fila de Espera -->
            <div class="bg-gray-900 rounded-lg border border-gray-800 flex flex-col overflow-hidden flex-1 min-h-0">
                <div class="p-1.5 bg-gray-800 border-b border-gray-700 flex justify-between items-center flex-shrink-0">
                    <h3 class="text-[10px] font-bold text-yellow-500 uppercase tracking-wider">Fila de Espera</h3>
                                    <span class="bg-gray-950 text-[9px] px-1.5 rounded text-gray-400 border border-gray-700">{{ peladaQueue.length }}</span>
                </div>
                                <div class="flex-1 p-1.5 overflow-y-auto bg-black/20" @dragover.prevent @drop="onPeladaDrop($event, 'queue')">
                                    <div class="space-y-0.5">
                                        <pelada-player-card 
                                            v-for="(p, index) in peladaQueue" 
                            :key="p.id" 
                            :player="p" 
                            :index="index + 1" 
                            :mini="true" 
                            :show-remove="true"
                            :show-reorder="true"
                            :is-first="index === 0"
                                            :is-last="index === peladaQueue.length - 1"
                                            @dragstart="onPeladaDragStart($event, p, 'queue')"
                                            @drop-on-card="onDropOnPeladaQueueCard"
                                            @remove-click="removeFromPeladaQueue"
                                            @move-up="movePeladaPlayerUp"
                                            @move-down="movePeladaPlayerDown"
                                        ></pelada-player-card>
                                        <div v-if="peladaQueue.length === 0" class="text-center text-gray-600 text-[10px] py-10 italic">
                            NinguÃ©m na espera
                        </div>
                    </div>
                </div>
            </div>

                            <!-- Fila de Goleiros -->
            <div class="bg-gray-900 rounded-lg border border-yellow-600/40 flex flex-col overflow-hidden flex-shrink-0" style="max-height: 35%;">
                <div class="p-1.5 bg-yellow-900/30 border-b border-yellow-600/30 flex justify-between items-center flex-shrink-0">
                    <h3 class="text-[10px] font-bold text-yellow-400 uppercase tracking-wider flex items-center gap-1">
                        <i class="ph ph-hand-fist"></i> Goleiros (GK's)
                    </h3>
                                    <span class="bg-gray-950 text-[9px] px-1.5 rounded text-yellow-400 border border-yellow-600/50">{{ peladaGoalkeeperQueue.length }}</span>
                </div>
                                <div class="flex-1 p-1.5 overflow-y-auto bg-yellow-950/10" @dragover.prevent @drop="onPeladaDrop($event, 'goalkeeperQueue')">
                    <div class="space-y-0.5">
                                        <pelada-player-card 
                                            v-for="(p, index) in peladaGoalkeeperQueue" 
                            :key="p.id" 
                            :player="p" 
                            :index="index + 1" 
                            :mini="true" 
                            :show-remove="true"
                            :show-reorder="true"
                            :is-first="index === 0"
                                            :is-last="index === peladaGoalkeeperQueue.length - 1"
                                            @dragstart="onPeladaDragStart($event, p, 'goalkeeperQueue')"
                                            @drop-on-card="onDropOnPeladaGoalkeeperCard"
                                            @remove-click="removeFromPeladaGoalkeeperQueue"
                                            @move-up="movePeladaGoalkeeperUp"
                                            @move-down="movePeladaGoalkeeperDown"
                                        ></pelada-player-card>
                                        <div v-if="peladaGoalkeeperQueue.length === 0" class="text-center text-gray-600 text-[10px] py-6 italic">
                            Nenhum goleiro na espera
                        </div>
                    </div>
                </div>
            </div>
        </section>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ==================== MODAL: CRIAR GRUPO ==================== -->
    <div v-if="showCreateGroupModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop" @click.self="showCreateGroupModal = false">
        <div class="bg-gray-900 border border-gray-700 rounded-2xl w-full max-w-md shadow-2xl">
            <div class="p-6 border-b border-gray-800">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    <i class="ph ph-users-three text-emerald-400"></i>
                    Criar novo grupo
                </h2>
</div>

            <form @submit.prevent="createGroup" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Nome do grupo *</label>
                    <input 
                        v-model="createGroupForm.nome_do_grupo" 
                        type="text" 
                        required
                        placeholder="Ex: Pelada de Quinta"
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 input-focus"
                    >
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Cidade</label>
                        <input 
                            v-model="createGroupForm.cidade_do_grupo" 
                            type="text" 
                            placeholder="Ex: SÃ£o Paulo"
                            class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 input-focus"
                        >
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Estado</label>
                        <input 
                            v-model="createGroupForm.estado_do_grupo" 
                            type="text" 
                            placeholder="Ex: SP"
                            maxlength="2"
                            class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 input-focus uppercase"
                        >
                    </div>
                </div>
                
                <div v-if="createGroupError" class="bg-red-900/50 border border-red-700 rounded-lg p-3 text-red-300 text-sm">
                    {{ createGroupError }}
                </div>
                
                <div class="flex gap-3 pt-2">
                    <button 
                        type="button" 
                        @click="showCreateGroupModal = false"
                        class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-3 rounded-lg font-medium transition"
                    >
                        Cancelar
                    </button>
                    <button 
                        type="submit" 
                        :disabled="creatingGroup"
                        class="flex-1 btn-primary text-white py-3 rounded-lg font-medium disabled:opacity-50"
                    >
                        <span v-if="creatingGroup" class="flex items-center justify-center gap-2">
                            <i class="ph ph-spinner animate-spin"></i> Criando...
                        </span>
                        <span v-else>Criar grupo</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ==================== MODAL: GERENCIAR MEMBROS ==================== -->
    <div v-if="showMembersModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop" @click.self="showMembersModal = false">
        <div class="bg-gray-900 border border-gray-700 rounded-2xl w-full max-w-2xl shadow-2xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b border-gray-800 flex items-center justify-between flex-shrink-0">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    <i class="ph ph-users text-emerald-400"></i>
                    Membros do grupo
                </h2>
                <button @click="showMembersModal = false" class="p-2 hover:bg-gray-800 rounded-lg transition">
                    <i class="ph ph-x text-gray-400"></i>
                </button>
            </div>
            
            <!-- Convidar -->
            <div class="p-4 border-b border-gray-800 flex-shrink-0">
                <form @submit.prevent="invitePlayer" class="flex gap-2">
                    <input 
                        v-model="inviteEmail" 
                        type="email" 
                        placeholder="E-mail do jogador para convidar"
                        required
                        class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500 input-focus"
                    >
                    <label class="flex items-center gap-2 text-sm text-gray-400">
                        <input type="checkbox" v-model="inviteAsAdmin" class="accent-emerald-500">
                        Admin
                    </label>
                    <button 
                        type="submit" 
                        :disabled="invitingPlayer"
                        class="btn-primary px-4 py-2 rounded-lg font-medium disabled:opacity-50"
                    >
                        <span v-if="invitingPlayer"><i class="ph ph-spinner animate-spin"></i></span>
                        <span v-else>Convidar</span>
                    </button>
                </form>
                <div v-if="inviteError" class="mt-2 text-red-400 text-sm">{{ inviteError }}</div>
                <div v-if="inviteSuccess" class="mt-2 text-emerald-400 text-sm">{{ inviteSuccess }}</div>
            </div>
            
            <!-- Lista de membros -->
            <div class="flex-1 overflow-y-auto p-4">
                <div v-if="loadingMembers" class="flex items-center justify-center py-10">
                    <i class="ph ph-spinner animate-spin text-2xl text-emerald-500"></i>
                </div>
                
                <div v-else>
                    <!-- Pendentes -->
                    <div v-if="pendingMembers.length > 0" class="mb-6">
                        <h3 class="text-sm font-semibold text-yellow-400 mb-3 flex items-center gap-2">
                            <i class="ph ph-clock"></i>
                            Convites Pendentes ({{ pendingMembers.length }})
                        </h3>
                        <div class="space-y-2">
                            <div 
                                v-for="member in pendingMembers" 
                                :key="member.jogador_id"
                                class="flex items-center justify-between bg-gray-800 rounded-lg p-3"
                            >
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full avatar-placeholder flex items-center justify-center overflow-hidden">
                                        <img v-if="member.jogadores?.foto_do_jogador" :src="member.jogadores.foto_do_jogador" class="w-full h-full object-cover">
                                        <i v-else class="ph ph-user text-gray-400"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-white">{{ member.jogadores?.apelido_do_jogador || member.jogadores?.nome_do_jogador }}</p>
                                        <p class="text-xs text-gray-400">{{ member.jogadores?.email_do_jogador }}</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs bg-yellow-500/20 text-yellow-400 px-2 py-1 rounded">Pendente</span>
                                    <button 
                                        @click="cancelInvite(member)"
                                        class="p-2 text-red-400 hover:bg-red-900/30 rounded-lg transition"
                                        title="Cancelar convite"
                                    >
                                        <i class="ph ph-x"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ativos -->
                    <div>
                        <h3 class="text-sm font-semibold text-emerald-400 mb-3 flex items-center gap-2">
                            <i class="ph ph-check-circle"></i>
                            Membros Ativos ({{ activeMembers.length }})
                        </h3>
                        <div class="space-y-2">
                            <div 
                                v-for="member in activeMembers" 
                                :key="member.jogador_id"
                                class="flex items-center justify-between bg-gray-800 rounded-lg p-3"
                            >
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full avatar-placeholder flex items-center justify-center overflow-hidden">
                                        <img v-if="member.jogadores?.foto_do_jogador" :src="member.jogadores.foto_do_jogador" class="w-full h-full object-cover">
                                        <i v-else class="ph ph-user text-gray-400"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-white">{{ member.jogadores?.apelido_do_jogador || member.jogadores?.nome_do_jogador }}</p>
                                        <p class="text-xs text-gray-400">{{ member.jogadores?.email_do_jogador }}</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span v-if="member.jogador_id === selectedGroupForMembers?.id_do_responsavel" class="text-xs bg-purple-500/20 text-purple-400 px-2 py-1 rounded">ResponsÃ¡vel</span>
                                    <span v-else-if="member.is_admin" class="text-xs bg-emerald-500/20 text-emerald-400 px-2 py-1 rounded">Admin</span>
                                    <span v-else class="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded">Membro</span>
                                    
                                    <!-- AÃ§Ãµes (nÃ£o mostrar para responsÃ¡vel) -->
                                    <div v-if="member.jogador_id !== selectedGroupForMembers?.id_do_responsavel" class="flex items-center gap-1">
                                        <button 
                                            v-if="!member.is_admin"
                                            @click="promoteToAdmin(member)"
                                            class="p-2 text-emerald-400 hover:bg-emerald-900/30 rounded-lg transition"
                                            title="Promover a Admin"
                                        >
                                            <i class="ph ph-arrow-up"></i>
                                        </button>
                                        <button 
                                            v-if="member.is_admin && member.jogador_id !== selectedGroupForMembers?.id_do_responsavel"
                                            @click="demoteFromAdmin(member)"
                                            class="p-2 text-yellow-400 hover:bg-yellow-900/30 rounded-lg transition"
                                            title="Remover Admin"
                                        >
                                            <i class="ph ph-arrow-down"></i>
                                        </button>
                                        <button 
                                            @click="removeMember(member)"
                                            class="p-2 text-red-400 hover:bg-red-900/30 rounded-lg transition"
                                            title="Remover do grupo"
                                        >
                                            <i class="ph ph-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Template do Player Card para Pelada -->
<script type="text/x-template" id="pelada-player-card-template">
    <div 
        class="draggable-item bg-gray-800 hover:bg-gray-700 rounded flex justify-between items-center shadow-sm border-l-[3px] select-none transition group relative"
        :class="[
            player.role === 'GK' ? 'border-yellow-600' : 'border-blue-600',
            mini ? 'p-1 h-6' : 'p-1.5 mb-1',
            isDragOver ? 'drag-over-item' : ''
        ]"
        draggable="true"
        @dragover.prevent="onDragOver"
        @dragleave="isDragOver = false"
        @drop.stop="onDrop"
    >
        <div class="flex items-center gap-1.5 overflow-hidden w-full">
            <span v-if="index" class="text-[9px] font-mono bg-gray-900 w-3.5 h-3.5 flex items-center justify-center rounded text-gray-400 flex-shrink-0 leading-none">{{ index }}</span>
            <div class="flex flex-col truncate w-full justify-center">
                <span class="font-bold text-gray-300 truncate leading-none" :class="mini ? 'text-[9px]' : 'text-[11px]'">{{ player.name }}</span>
                <span v-if="!mini && player.role === 'GK'" class="text-[7px] text-yellow-500 uppercase font-bold leading-none mt-[1px]">Goleiro</span>
            </div>
        </div>
        
        <div class="flex items-center gap-0.5">
            <button v-if="showReorder && !isFirst" @click.stop="$emit('move-up', player.id)" class="opacity-0 group-hover:opacity-100 text-blue-400 hover:text-blue-300 p-0.5 rounded hover:bg-gray-900 transition" title="Mover para cima">
                <i class="ph ph-caret-up text-[10px]"></i>
            </button>
            <button v-if="showReorder && !isLast" @click.stop="$emit('move-down', player.id)" class="opacity-0 group-hover:opacity-100 text-blue-400 hover:text-blue-300 p-0.5 rounded hover:bg-gray-900 transition" title="Mover para baixo">
                <i class="ph ph-caret-down text-[10px]"></i>
            </button>
            
            <span v-if="player.matchesPlayed > 0" class="text-[8px] font-bold bg-cyan-600 text-white px-1 py-0.5 rounded-full leading-none" :title="player.matchesPlayed + ' partida(s)'">{{ player.matchesPlayed }}</span>
            <span v-if="mini && player.role === 'GK'" class="text-[7px] text-yellow-500 font-bold px-1">GK</span>
            <i v-if="!mini" class="ph ph-dots-six-vertical text-gray-600 text-[10px] group-hover:text-gray-400 ml-1"></i>
            <button v-if="showRemove" @click.stop="$emit('remove-click', player.id)" class="ml-1 text-red-500 hover:text-red-300 p-0.5 rounded hover:bg-gray-900 transition" title="Remover">
                <i class="ph ph-x text-[9px]"></i>
            </button>
        </div>
    </div>
</script>

<script>
    // ==================== SUPABASE CLIENT ====================
    // const SUPABASE_URL = CONFIG.SUPABASE_URL;
    // const SUPABASE_ANON_KEY = CONFIG.SUPABASE_ANON_KEY;

    const SUPABASE_URL = 'https://luibashtrpxxohqnxgil.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1aWJhc2h0cnB4eG9ocW54Z2lsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzNTE4NzgsImV4cCI6MjA4MzkyNzg3OH0.jzVX12VCQlslr_IJWKNc0ZR5zZBzOFLD4kjKac9SYqM';
    
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // ==================== VUE APP ====================
    const { createApp, reactive, ref, computed, onMounted, watch } = Vue;

    const app = createApp({
        setup() {
            // ==================== AUTH STATE ====================
            const session = ref(null);
            const userProfile = ref(null);
            const authMode = ref('login');
            const authForm = reactive({ email: '', password: '', fullName: '' });
            const authError = ref('');
            const authSuccess = ref('');
            const authLoading = ref(false);
            
            // ==================== APP STATE ====================
            const currentView = ref('grupos');
            const sidebarExpanded = ref(true);
            const currentGroupId = ref(null);
            const currentGroupName = ref('');
            
            // ==================== GRUPOS STATE ====================
            const loadingGroups = ref(false);
            const pendingInvites = ref([]);
            const adminGroups = ref([]);
            const memberGroups = ref([]);
            
            // ==================== CREATE GROUP ====================
            const showCreateGroupModal = ref(false);
            const createGroupForm = reactive({ nome_do_grupo: '', cidade_do_grupo: '', estado_do_grupo: '' });
            const createGroupError = ref('');
            const creatingGroup = ref(false);
            
            // ==================== MEMBERS MODAL ====================
            const showMembersModal = ref(false);
            const selectedGroupForMembers = ref(null);
            const loadingMembers = ref(false);
            const pendingMembers = ref([]);
            const activeMembers = ref([]);
            const inviteEmail = ref('');
            const inviteAsAdmin = ref(false);
            const invitingPlayer = ref(false);
            const inviteError = ref('');
            const inviteSuccess = ref('');
            
            // ==================== PROFILE STATE ====================
            const profileForm = reactive({
                nome_do_jogador: '',
                apelido_do_jogador: '',
                numero_telefone: '',
                cidade_do_jogador: '',
                estado_do_jogador: '',
                sexo_do_jogador: '',
                foto_do_jogador: ''
            });
            const profileError = ref('');
            const profileSuccess = ref('');
            const savingProfile = ref(false);
            
            // ==================== PELADA STATE ====================
            const peladaConfig = reactive({
                playersPerTeam: 5, 
                timeFirstMatch: 10, 
                timeNormalMatch: 7
            });
            const peladaStatus = reactive({
                isFirstMatch: true,
                teamsGenerated: false,
                lastUpdate: Date.now()
            });
            const peladaUI = reactive({ showRegister: true });
            const peladaInput = reactive({ goalkeepers: '', lines: '' });
            const peladaAllPlayers = ref([]); 
            const peladaMatch = reactive({ 
                teamA: [], teamB: [], scoreA: 0, scoreB: 0, 
                timeLeft: 600, timerRunning: false, hasStarted: false, lastWinner: null 
            });
            const peladaQueue = ref([]);
            const peladaGoalkeeperQueue = ref([]);
            
            let peladaTimerInterval = null;
            let peladaDraggedItem = null;
            let peladaSourceList = null;
            
            // ==================== PELADA COMPUTEDS ====================
            const peladaFormattedTime = computed(() => {
                const m = Math.floor(peladaMatch.timeLeft / 60).toString().padStart(2, '0');
                const s = (peladaMatch.timeLeft % 60).toString().padStart(2, '0');
                return `${m}:${s}`;
            });
            const peladaPaidCount = computed(() => peladaAllPlayers.value.filter(p => p.paid).length);
            const peladaArrivedCount = computed(() => peladaAllPlayers.value.filter(p => p.arrived).length);
            
            // ==================== AUTH FUNCTIONS ====================
            const handleAuth = async () => {
                authError.value = '';
                authSuccess.value = '';
                authLoading.value = true;
                
                try {
                    if (authMode.value === 'login') {
                        const { data, error } = await supabaseClient.auth.signInWithPassword({
                            email: authForm.email,
                            password: authForm.password
                        });
                        if (error) throw error;
                    } else {
                        // 1. Criar usuÃ¡rio no Auth
                        const { data, error } = await supabaseClient.auth.signUp({
                            email: authForm.email,
                            password: authForm.password,
                            options: {
                                data: { full_name: authForm.fullName }
                            }
                        });
                        if (error) throw error;
                        
                        // NOTA: O jogador em public.jogadores Ã© criado automaticamente
                        // pelo trigger on_auth_user_created no banco de dados.
                        // Isso Ã© mais robusto pois funciona mesmo antes da confirmaÃ§Ã£o de email.
                        
                        authSuccess.value = 'Conta criada! Verifique seu e-mail para confirmar.';
                    }
                } catch (err) {
                    authError.value = err.message || 'Erro ao autenticar';
                } finally {
                    authLoading.value = false;
                }
            };
            
            const handleLogout = async () => {
                await supabaseClient.auth.signOut();
                session.value = null;
                userProfile.value = null;
            };
            
            const bootstrapProfile = async (user) => {
                if (!user) return;
                
                // Buscar perfil existente
                const { data: profile, error: fetchError } = await supabaseClient
                    .from('jogadores')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                
                // PGRST116 = "no rows returned" (perfil nÃ£o existe ainda)
                // 42501 = "permission denied" (RLS bloqueando - pode acontecer durante signup)
                if (fetchError) {
                    if (fetchError.code === 'PGRST116') {
                        // Perfil nÃ£o existe, vamos criar
                        console.log('Perfil nÃ£o encontrado, criando...');
                    } else if (fetchError.code === '42501') {
                        // Permission denied - provavelmente sessÃ£o invÃ¡lida ou RLS
                        console.warn('Sem permissÃ£o para acessar jogadores. Verifique se o email foi confirmado.');
                        return;
                    } else {
                        console.error('Erro ao buscar perfil:', fetchError);
                        return;
                    }
                }
                
                if (!profile) {
                    // Criar perfil
                    const newProfile = {
                        id: user.id,
                        email_do_jogador: user.email,
                        nome_do_jogador: user.user_metadata?.full_name || user.email,
                        apelido_do_jogador: null,
                        foto_do_jogador: null,
                        cidade_do_jogador: null,
                        estado_do_jogador: null,
                        sexo_do_jogador: null,
                        numero_telefone: null,
                        created_at: new Date().toISOString()
                    };
                    
                    const { data: created, error: createError } = await supabaseClient
                        .from('jogadores')
                        .insert(newProfile)
                        .select()
                        .single();
                    
                    if (createError) {
                        // Se jÃ¡ existe (violaÃ§Ã£o de unique), tentar buscar novamente
                        if (createError.code === '23505') {
                            const { data: existing } = await supabaseClient
                                .from('jogadores')
                                .select('*')
                                .eq('id', user.id)
                                .single();
                            if (existing) {
                                userProfile.value = existing;
                            }
                        } else {
                            console.error('Erro ao criar perfil:', createError);
                            return;
                        }
                    } else {
                        userProfile.value = created;
                    }
                } else {
                    userProfile.value = profile;
                }
                
                // Preencher formulÃ¡rio de perfil
                if (userProfile.value) {
                    Object.assign(profileForm, {
                        nome_do_jogador: userProfile.value.nome_do_jogador || '',
                        apelido_do_jogador: userProfile.value.apelido_do_jogador || '',
                        numero_telefone: userProfile.value.numero_telefone || '',
                        cidade_do_jogador: userProfile.value.cidade_do_jogador || '',
                        estado_do_jogador: userProfile.value.estado_do_jogador || '',
                        sexo_do_jogador: userProfile.value.sexo_do_jogador || '',
                        foto_do_jogador: userProfile.value.foto_do_jogador || ''
                    });
                }
            };
            
            // ==================== NAVIGATION ====================
            const navigateTo = (view) => {
                currentView.value = view;
                if (view === 'grupos') {
                    loadGroups();
                }
            };
            
            // ==================== GROUPS FUNCTIONS ====================
            const loadGroups = async () => {
                if (!session.value?.user) return;
                loadingGroups.value = true;
                
                try {
                    const userId = session.value.user.id;
                    
                    // Buscar todas as associaÃ§Ãµes do usuÃ¡rio
                    const { data: memberships, error } = await supabaseClient
                        .from('grupos_jogadores')
                        .select(`
                            grupo_id,
                            jogador_id,
                            is_admin,
                            status,
                            grupos:grupos (
                                id,
                                nome_do_grupo,
                                cidade_do_grupo,
                                estado_do_grupo,
                                id_do_responsavel,
                                archieved_at
                            )
                        `)
                        .eq('jogador_id', userId);
                    
                    if (error) throw error;
                    
                    // Filtrar grupos nÃ£o arquivados
                    const activeMemberships = (memberships || []).filter(m => !m.grupos?.archieved_at);
                    
                    // Separar por tipo
                    pendingInvites.value = activeMemberships.filter(m => m.status === 'pending');
                    
                    const accepted = activeMemberships.filter(m => m.status === 'accepted');
                    
                    // Admin groups: is_admin OU Ã© responsÃ¡vel
                    adminGroups.value = accepted.filter(m => 
                        m.is_admin || m.grupos?.id_do_responsavel === userId
                    );
                    
                    // Member groups: nÃ£o Ã© admin E nÃ£o Ã© responsÃ¡vel
                    memberGroups.value = accepted.filter(m => 
                        !m.is_admin && m.grupos?.id_do_responsavel !== userId
                    );
                    
                } catch (err) {
                    console.error('Erro ao carregar grupos:', err);
                } finally {
                    loadingGroups.value = false;
                }
            };
            
            const openCreateGroupModal = () => {
                createGroupForm.nome_do_grupo = '';
                createGroupForm.cidade_do_grupo = '';
                createGroupForm.estado_do_grupo = '';
                createGroupError.value = '';
                showCreateGroupModal.value = true;
            };
            
            const createGroup = async () => {
                if (!createGroupForm.nome_do_grupo.trim()) {
                    createGroupError.value = 'Nome do grupo Ã© obrigatÃ³rio';
                    return;
                }
                
                creatingGroup.value = true;
                createGroupError.value = '';
                
                try {
                    const userId = session.value.user.id;
                    const now = new Date().toISOString();
                    
                    // 1. Criar o grupo
                    const { data: grupo, error: grupoError } = await supabaseClient
                        .from('grupos')
                        .insert({
                            nome_do_grupo: createGroupForm.nome_do_grupo.trim(),
                            cidade_do_grupo: createGroupForm.cidade_do_grupo.trim() || null,
                            estado_do_grupo: createGroupForm.estado_do_grupo.trim().toUpperCase() || null,
                            id_do_responsavel: userId,
                            created_by: userId,
                            last_modified_by: userId,
                            created_at: now,
                            modified_at: now
                        })
                        .select()
                        .single();
                    
                    if (grupoError) throw grupoError;
                    
                    // 2. Adicionar criador como membro admin
                    const { error: memberError } = await supabaseClient
                        .from('grupos_jogadores')
                        .insert({
                            grupo_id: grupo.id,
                            jogador_id: userId,
                            is_admin: true,
                            status: 'accepted',
                            accepted_at: now,
                            created_at: now
                        });
                    
                    if (memberError) throw memberError;
                    
                    showCreateGroupModal.value = false;
                    await loadGroups();
                    
                } catch (err) {
                    createGroupError.value = err.message || 'Erro ao criar grupo';
                } finally {
                    creatingGroup.value = false;
                }
            };
            
            const acceptInvite = async (invite) => {
                try {
                    const { error } = await supabaseClient
                        .from('grupos_jogadores')
                        .update({
                            status: 'accepted',
                            accepted_at: new Date().toISOString()
                        })
                        .eq('grupo_id', invite.grupo_id)
                        .eq('jogador_id', session.value.user.id);
                    
                    if (error) throw error;
                    await loadGroups();
                } catch (err) {
                    alert('Erro ao aceitar convite: ' + err.message);
                }
            };
            
            const declineInvite = async (invite) => {
                if (!confirm('Tem certeza que deseja recusar este convite?')) return;
                
                try {
                    const { error } = await supabaseClient
                        .from('grupos_jogadores')
                        .delete()
                        .eq('grupo_id', invite.grupo_id)
                        .eq('jogador_id', session.value.user.id);
                    
                    if (error) throw error;
                    await loadGroups();
                } catch (err) {
                    alert('Erro ao recusar convite: ' + err.message);
                }
            };
            
            // ==================== MEMBERS MODAL FUNCTIONS ====================
            const openMembersModal = async (grupo) => {
                selectedGroupForMembers.value = grupo;
                showMembersModal.value = true;
                inviteEmail.value = '';
                inviteAsAdmin.value = false;
                inviteError.value = '';
                inviteSuccess.value = '';
                await loadMembers();
            };
            
            const loadMembers = async () => {
                if (!selectedGroupForMembers.value) return;
                loadingMembers.value = true;
                
                try {
                    // Debug: verificar o ID do grupo
                    const grupoId = selectedGroupForMembers.value.id;
                    console.log('Carregando membros do grupo:', grupoId);
                    
                    const { data, error } = await supabaseClient
                        .from('grupos_jogadores')
                        .select(`
                            grupo_id,
                            jogador_id,
                            is_admin,
                            status,
                            jogadores:jogadores (
                                id,
                                nome_do_jogador,
                                apelido_do_jogador,
                                email_do_jogador,
                                foto_do_jogador
                            )
                        `)
                        .eq('grupo_id', grupoId);
                    
                    if (error) throw error;
                    
                    console.log('Membros encontrados:', data);
                    
                    pendingMembers.value = (data || []).filter(m => m.status === 'pending');
                    activeMembers.value = (data || []).filter(m => m.status === 'accepted');
                    
                    console.log('Membros ativos:', activeMembers.value.length);
                    console.log('Membros pendentes:', pendingMembers.value.length);
                    
                } catch (err) {
                    console.error('Erro ao carregar membros:', err);
                } finally {
                    loadingMembers.value = false;
                }
            };
            
            const invitePlayer = async () => {
                if (!inviteEmail.value.trim()) return;
                
                invitingPlayer.value = true;
                inviteError.value = '';
                inviteSuccess.value = '';
                
                try {
                    // Buscar jogador por email (case-insensitive)
                    const { data: jogador, error: searchError } = await supabaseClient
                        .from('jogadores')
                        .select('id, nome_do_jogador, email_do_jogador')
                        .ilike('email_do_jogador', inviteEmail.value.trim())
                        .single();
                    
                    if (searchError || !jogador) {
                        inviteError.value = 'Jogador nÃ£o encontrado. O jogador precisa se cadastrar no app antes de receber convite.';
                        return;
                    }
                    
                    // Verificar se jÃ¡ existe associaÃ§Ã£o
                    const { data: existing } = await supabaseClient
                        .from('grupos_jogadores')
                        .select('status')
                        .eq('grupo_id', selectedGroupForMembers.value.id)
                        .eq('jogador_id', jogador.id)
                        .single();
                    
                    if (existing) {
                        inviteError.value = existing.status === 'pending' 
                            ? 'Este jogador jÃ¡ possui um convite pendente.'
                            : 'Este jogador jÃ¡ Ã© membro do grupo.';
                        return;
                    }
                    
                    // Criar convite
                    const now = new Date().toISOString();
                    const { error: inviteErr } = await supabaseClient
                        .from('grupos_jogadores')
                        .insert({
                            grupo_id: selectedGroupForMembers.value.id,
                            jogador_id: jogador.id,
                            is_admin: inviteAsAdmin.value,
                            status: 'pending',
                            invited_by: session.value.user.id,
                            invited_at: now,
                            created_at: now
                        });
                    
                    if (inviteErr) throw inviteErr;
                    
                    inviteSuccess.value = `Convite enviado para ${jogador.nome_do_jogador}!`;
                    inviteEmail.value = '';
                    inviteAsAdmin.value = false;
                    await loadMembers();
                    
                } catch (err) {
                    inviteError.value = err.message || 'Erro ao enviar convite';
                } finally {
                    invitingPlayer.value = false;
                }
            };
            
            const cancelInvite = async (member) => {
                if (!confirm('Cancelar este convite?')) return;
                
                try {
                    const { error } = await supabaseClient
                        .from('grupos_jogadores')
                        .delete()
                        .eq('grupo_id', selectedGroupForMembers.value.id)
                        .eq('jogador_id', member.jogador_id);
                    
                    if (error) throw error;
                    await loadMembers();
                } catch (err) {
                    alert('Erro: ' + err.message);
                }
            };
            
            const promoteToAdmin = async (member) => {
                try {
                    const { error } = await supabaseClient
                        .from('grupos_jogadores')
                        .update({ is_admin: true })
                        .eq('grupo_id', selectedGroupForMembers.value.id)
                        .eq('jogador_id', member.jogador_id);
                    
                    if (error) throw error;
                    await loadMembers();
                } catch (err) {
                    alert('Erro: ' + err.message);
                }
            };
            
            const demoteFromAdmin = async (member) => {
                try {
                    const { error } = await supabaseClient
                        .from('grupos_jogadores')
                        .update({ is_admin: false })
                        .eq('grupo_id', selectedGroupForMembers.value.id)
                        .eq('jogador_id', member.jogador_id);
                    
                    if (error) throw error;
                    await loadMembers();
                } catch (err) {
                    alert('Erro: ' + err.message);
                }
            };
            
            const removeMember = async (member) => {
                if (member.jogador_id === selectedGroupForMembers.value.id_do_responsavel) {
                    alert('NÃ£o Ã© possÃ­vel remover o responsÃ¡vel do grupo.');
                    return;
                }
                
                if (!confirm('Remover este membro do grupo?')) return;
                
                try {
                    const { error } = await supabaseClient
                        .from('grupos_jogadores')
                        .delete()
                        .eq('grupo_id', selectedGroupForMembers.value.id)
                        .eq('jogador_id', member.jogador_id);
                    
                    if (error) throw error;
                    await loadMembers();
                } catch (err) {
                    alert('Erro: ' + err.message);
                }
            };
            
            // ==================== PROFILE FUNCTIONS ====================
            const saveProfile = async () => {
                savingProfile.value = true;
                profileError.value = '';
                profileSuccess.value = '';
                
                try {
                    const { error } = await supabaseClient
                        .from('jogadores')
                        .update({
                            nome_do_jogador: profileForm.nome_do_jogador,
                            apelido_do_jogador: profileForm.apelido_do_jogador || null,
                            numero_telefone: profileForm.numero_telefone || null,
                            cidade_do_jogador: profileForm.cidade_do_jogador || null,
                            estado_do_jogador: profileForm.estado_do_jogador?.toUpperCase() || null,
                            sexo_do_jogador: profileForm.sexo_do_jogador || null,
                            foto_do_jogador: profileForm.foto_do_jogador || null,
                            modified_at: new Date().toISOString()
                        })
                        .eq('id', session.value.user.id);
                    
                    if (error) throw error;
                    
                    // Atualizar userProfile
                    userProfile.value = { ...userProfile.value, ...profileForm };
                    profileSuccess.value = 'Perfil atualizado com sucesso!';
                    
                    setTimeout(() => { profileSuccess.value = ''; }, 3000);
                } catch (err) {
                    profileError.value = err.message || 'Erro ao salvar perfil';
                } finally {
                    savingProfile.value = false;
                }
            };
            
            // ==================== PELADA FUNCTIONS ====================
            const getPeladaStorageKey = () => {
                if (!session.value?.user?.id || !currentGroupId.value) return null;
                return `lapelota:pelada:${session.value.user.id}:${currentGroupId.value}`;
            };
            
            const savePeladaData = () => {
                const key = getPeladaStorageKey();
                if (!key) return;
                
                const data = {
                    config: peladaConfig,
                    status: peladaStatus,
                    allPlayers: peladaAllPlayers.value,
                    match: peladaMatch,
                    queue: peladaQueue.value,
                    goalkeeperQueue: peladaGoalkeeperQueue.value,
                    timestamp: Date.now()
                };
                localStorage.setItem(key, JSON.stringify(data));
            };
            
            const loadPeladaData = () => {
                const key = getPeladaStorageKey();
                if (!key) return false;
                
                const saved = localStorage.getItem(key);
                if (saved) {
                    const data = JSON.parse(saved);
                    // Verificar expiraÃ§Ã£o de 24h
                    if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
                        Object.assign(peladaConfig, data.config || {});
                        Object.assign(peladaStatus, data.status || {});
                        Object.assign(peladaMatch, data.match || {});
                        
                        const ensurePlayerProps = (players) => {
                            return (players || []).map(p => ({ 
                                ...p, 
                                matchesPlayed: p.matchesPlayed || 0, 
                                arrived: p.arrived || false 
                            }));
                        };
                        
                        peladaAllPlayers.value = ensurePlayerProps(data.allPlayers);
                        peladaMatch.teamA = ensurePlayerProps(peladaMatch.teamA);
                        peladaMatch.teamB = ensurePlayerProps(peladaMatch.teamB);
                        peladaQueue.value = ensurePlayerProps(data.queue);
                        peladaGoalkeeperQueue.value = ensurePlayerProps(data.goalkeeperQueue);
                        peladaMatch.timerRunning = false;
                        return true;
                    } else {
                        localStorage.removeItem(key);
                    }
                }
                return false;
            };
            
            const loadGroupPlayersForPelada = async (grupoId) => {
                try {
                    console.log('Carregando jogadores para pelada do grupo:', grupoId);
                    
                    const { data, error } = await supabaseClient
                        .from('grupos_jogadores')
                        .select(`
                            jogador_id,
                            is_admin,
                            status,
                            jogadores:jogadores (
                                id,
                                nome_do_jogador,
                                apelido_do_jogador,
                                foto_do_jogador
                            )
                        `)
                        .eq('grupo_id', grupoId)
                        .eq('status', 'accepted');
                    
                    if (error) throw error;
                    
                    console.log('Jogadores encontrados no banco:', data);
                    
                    // Mapear para formato do mÃ³dulo de pelada
                    const players = (data || []).map(d => ({
                        id: d.jogadores?.id || d.jogador_id || String(Date.now() + Math.random()),
                        name: d.jogadores?.apelido_do_jogador || d.jogadores?.nome_do_jogador || 'Jogador',
                        role: 'LINE',
                        paid: false,
                        arrived: false,
                        matchesPlayed: 0
                    }));
                    
                    console.log('Jogadores mapeados para pelada:', players);
                    
                    return players;
                } catch (err) {
                    console.error('Erro ao carregar jogadores do grupo:', err);
                    return [];
                }
            };
            
            const openPelada = async (grupoId) => {
                currentGroupId.value = grupoId;
                
                // Buscar nome do grupo
                const group = adminGroups.value.find(g => g.grupos?.id === grupoId);
                currentGroupName.value = group?.grupos?.nome_do_grupo || 'Grupo';
                
                // Tentar carregar dados salvos do localStorage
                const hasData = loadPeladaData();
                
                // SEMPRE carregar jogadores do banco para garantir lista atualizada
                const playersFromDB = await loadGroupPlayersForPelada(grupoId);
                
                if (!hasData) {
                    // Primeira vez: resetar estado e usar jogadores do banco
                    peladaQueue.value = [];
                    peladaGoalkeeperQueue.value = [];
                    peladaMatch.teamA = [];
                    peladaMatch.teamB = [];
                    peladaMatch.scoreA = 0;
                    peladaMatch.scoreB = 0;
                    peladaMatch.timeLeft = peladaConfig.timeFirstMatch * 60;
                    peladaMatch.timerRunning = false;
                    peladaMatch.hasStarted = false;
                    peladaMatch.lastWinner = null;
                    peladaStatus.isFirstMatch = true;
                    peladaStatus.teamsGenerated = false;
                    
                    // Usar jogadores do banco
                    peladaAllPlayers.value = playersFromDB;
                } else {
                    // JÃ¡ tem dados: mesclar jogadores do banco com os existentes
                    // Adicionar novos jogadores do banco que nÃ£o estÃ£o em nenhuma lista
                    const existingIds = new Set([
                        ...peladaAllPlayers.value.map(p => p.id),
                        ...peladaQueue.value.map(p => p.id),
                        ...peladaGoalkeeperQueue.value.map(p => p.id),
                        ...peladaMatch.teamA.map(p => p.id),
                        ...peladaMatch.teamB.map(p => p.id)
                    ]);
                    
                    // Adicionar jogadores novos do banco Ã  lista de cadastro
                    const newPlayers = playersFromDB.filter(p => !existingIds.has(p.id));
                    if (newPlayers.length > 0) {
                        console.log('Novos jogadores adicionados:', newPlayers);
                        peladaAllPlayers.value = [...peladaAllPlayers.value, ...newPlayers];
                    }
                }
                
                currentView.value = 'pelada';
            };
            
            const resetPelada = () => {
                if (!confirm("Limpar todos os dados desta pelada?")) return;
                const key = getPeladaStorageKey();
                if (key) localStorage.removeItem(key);
                openPelada(currentGroupId.value);
            };
            
            // FunÃ§Ãµes do mÃ³dulo de pelada
            const addPeladaPlayers = () => {
                const process = (text, role) => {
                    if (!text) return;
                    text.split('\n').forEach(line => {
                        const name = line.trim();
                        if (name) {
                            peladaAllPlayers.value.push({
                                id: String(Date.now()) + String(Math.random()),
                                name, role, paid: false, arrived: false, matchesPlayed: 0
                            });
                        }
                    });
                };
                process(peladaInput.goalkeepers, 'GK');
                process(peladaInput.lines, 'LINE');
                peladaInput.goalkeepers = '';
                peladaInput.lines = '';
                savePeladaData();
            };
            
            const markAllPeladaPaid = () => {
                if (confirm("Marcar TODOS os jogadores listados como PAGOS?")) {
                    peladaAllPlayers.value.forEach(p => p.paid = true);
                    savePeladaData();
                }
            };
            
            const markAllPeladaArrivedAndQueue = () => {
                if (confirm("Marcar TODOS como 'Chegaram' e enviar os PAGOS para a fila de espera?")) {
                    peladaAllPlayers.value.forEach(p => p.arrived = true);
                    
                    const paidPlayers = peladaAllPlayers.value.filter(p => p.paid);
                    paidPlayers.forEach(p => {
                        if (p.role === 'GK') {
                            if (!peladaGoalkeeperQueue.value.find(q => q.id === p.id)) {
                                peladaGoalkeeperQueue.value.push({ ...p });
                            }
                        } else {
                            if (!peladaQueue.value.find(q => q.id === p.id)) {
                                peladaQueue.value.push({ ...p });
                            }
                        }
                    });
                    
                    peladaAllPlayers.value = peladaAllPlayers.value.filter(p => !p.paid);
                    savePeladaData();
                }
            };

            const onPeladaArrivedChange = (player) => {
                if (player.arrived && player.paid) {
                    if (player.role === 'GK') {
                        if (!peladaGoalkeeperQueue.value.find(q => q.id === player.id)) {
                            peladaGoalkeeperQueue.value.push({ ...player });
                        }
                    } else {
                        if (!peladaQueue.value.find(q => q.id === player.id)) {
                            peladaQueue.value.push({ ...player });
                        }
                    }
                    peladaAllPlayers.value = peladaAllPlayers.value.filter(p => p.id !== player.id);
                }
                savePeladaData();
            };

            const onPeladaPaidChange = (player) => {
                if (player.paid && player.arrived) {
                    if (player.role === 'GK') {
                        if (!peladaGoalkeeperQueue.value.find(q => q.id === player.id)) {
                            peladaGoalkeeperQueue.value.push({ ...player });
                        }
                    } else {
                        if (!peladaQueue.value.find(q => q.id === player.id)) {
                            peladaQueue.value.push({ ...player });
                        }
                    }
                    peladaAllPlayers.value = peladaAllPlayers.value.filter(p => p.id !== player.id);
                }
                savePeladaData();
            };
            
            const onPeladaDragStartFromRegister = (evt, player) => {
                peladaDraggedItem = player;
                peladaSourceList = 'register';
                evt.dataTransfer.effectAllowed = 'move';
            };

            const onDropOnPeladaRegister = (evt) => {
                peladaDraggedItem = null;
                peladaSourceList = null;
            };
            
            const removeFromPeladaQueue = (id) => {
                if (confirm("Remover este jogador da fila de espera?")) {
                    peladaQueue.value = peladaQueue.value.filter(p => p.id !== id);
                    savePeladaData();
                }
            };
            
            const movePeladaPlayerUp = (id) => {
                const index = peladaQueue.value.findIndex(p => p.id === id);
                if (index > 0) {
                    [peladaQueue.value[index - 1], peladaQueue.value[index]] = [peladaQueue.value[index], peladaQueue.value[index - 1]];
                    savePeladaData();
                }
            };
            
            const movePeladaPlayerDown = (id) => {
                const index = peladaQueue.value.findIndex(p => p.id === id);
                if (index < peladaQueue.value.length - 1) {
                    [peladaQueue.value[index], peladaQueue.value[index + 1]] = [peladaQueue.value[index + 1], peladaQueue.value[index]];
                    savePeladaData();
                }
            };
            
            const removeFromPeladaGoalkeeperQueue = (id) => {
                if (confirm("Remover este goleiro da fila de goleiros?")) {
                    peladaGoalkeeperQueue.value = peladaGoalkeeperQueue.value.filter(p => p.id !== id);
                    savePeladaData();
                }
            };
            
            const movePeladaGoalkeeperUp = (id) => {
                const index = peladaGoalkeeperQueue.value.findIndex(p => p.id === id);
                if (index > 0) {
                    [peladaGoalkeeperQueue.value[index - 1], peladaGoalkeeperQueue.value[index]] = [peladaGoalkeeperQueue.value[index], peladaGoalkeeperQueue.value[index - 1]];
                    savePeladaData();
                }
            };
            
            const movePeladaGoalkeeperDown = (id) => {
                const index = peladaGoalkeeperQueue.value.findIndex(p => p.id === id);
                if (index < peladaGoalkeeperQueue.value.length - 1) {
                    [peladaGoalkeeperQueue.value[index], peladaGoalkeeperQueue.value[index + 1]] = [peladaGoalkeeperQueue.value[index + 1], peladaGoalkeeperQueue.value[index]];
                    savePeladaData();
                }
            };
            
            const onDropOnPeladaGoalkeeperCard = (targetPlayerId) => {
                if (!peladaDraggedItem) return;
                
                if (peladaSourceList === 'goalkeeperQueue') {
                    const fromIndex = peladaGoalkeeperQueue.value.findIndex(p => p.id === peladaDraggedItem.id);
                    const toIndex = peladaGoalkeeperQueue.value.findIndex(p => p.id === targetPlayerId);
                    
                    if (fromIndex > -1 && toIndex > -1) {
                        const [movedPlayer] = peladaGoalkeeperQueue.value.splice(fromIndex, 1);
                        peladaGoalkeeperQueue.value.splice(toIndex, 0, movedPlayer);
                    }
                } else {
                    if (peladaSourceList === 'teamA') peladaMatch.teamA = peladaMatch.teamA.filter(p => p.id !== peladaDraggedItem.id);
                    else if (peladaSourceList === 'teamB') peladaMatch.teamB = peladaMatch.teamB.filter(p => p.id !== peladaDraggedItem.id);
                    else if (peladaSourceList === 'queue') peladaQueue.value = peladaQueue.value.filter(p => p.id !== peladaDraggedItem.id);
                    
                    const toIndex = peladaGoalkeeperQueue.value.findIndex(p => p.id === targetPlayerId);
                    if (toIndex > -1) {
                        peladaGoalkeeperQueue.value.splice(toIndex, 0, peladaDraggedItem);
                    } else {
                        peladaGoalkeeperQueue.value.push(peladaDraggedItem);
                    }
                }
                
                peladaDraggedItem = null;
                peladaSourceList = null;
                savePeladaData();
            };
            
            const generatePeladaInitialTeams = () => {
                if (peladaQueue.value.length === 0 && peladaGoalkeeperQueue.value.length === 0) {
                    alert("As filas de espera estÃ£o vazias! Adicione jogadores primeiro.");
                    return;
                }

                peladaMatch.teamA = [];
                peladaMatch.teamB = [];

                const sortearEntreTimesComLimite = (jogadores, limiteA, limiteB) => {
                    const paraTimeA = [];
                    const paraTimeB = [];
                    
                    for (const jogador of jogadores) {
                        if (paraTimeA.length < limiteA && paraTimeB.length < limiteB) {
                            if (Math.random() < 0.5) {
                                paraTimeA.push(jogador);
                            } else {
                                paraTimeB.push(jogador);
                            }
                        } else if (paraTimeA.length < limiteA) {
                            paraTimeA.push(jogador);
                        } else if (paraTimeB.length < limiteB) {
                            paraTimeB.push(jogador);
                        }
                    }
                    
                    return { paraTimeA, paraTimeB };
                };

                const goleirosSelecionados = peladaGoalkeeperQueue.value.slice(0, 2);
                let goleirosUsados = 0;
                
                if (goleirosSelecionados.length >= 2) {
                    const resultado = sortearEntreTimesComLimite(goleirosSelecionados, 1, 1);
                    peladaMatch.teamA.push(...resultado.paraTimeA);
                    peladaMatch.teamB.push(...resultado.paraTimeB);
                    goleirosUsados = 2;
                } else if (goleirosSelecionados.length === 1) {
                    const gk = goleirosSelecionados[0];
                    if (Math.random() < 0.5) {
                        peladaMatch.teamA.push(gk);
                    } else {
                        peladaMatch.teamB.push(gk);
                    }
                    goleirosUsados = 1;
                }
                
                peladaGoalkeeperQueue.value = peladaGoalkeeperQueue.value.slice(goleirosUsados);
                
                const linesNeededA = peladaConfig.playersPerTeam - peladaMatch.teamA.length;
                const linesNeededB = peladaConfig.playersPerTeam - peladaMatch.teamB.length;
                const totalLinesNeeded = linesNeededA + linesNeededB;

                const jogadoresLinhaSelecionados = peladaQueue.value.slice(0, totalLinesNeeded);
                const resultadoLinhas = sortearEntreTimesComLimite(jogadoresLinhaSelecionados, linesNeededA, linesNeededB);
                peladaMatch.teamA.push(...resultadoLinhas.paraTimeA);
                peladaMatch.teamB.push(...resultadoLinhas.paraTimeB);
                peladaQueue.value = peladaQueue.value.slice(jogadoresLinhaSelecionados.length);
                
                const faltamA = peladaConfig.playersPerTeam - peladaMatch.teamA.length;
                const faltamB = peladaConfig.playersPerTeam - peladaMatch.teamB.length;
                
                if (faltamA > 0 || faltamB > 0) {
                    const jogadoresExtras = peladaQueue.value.slice(0, faltamA + faltamB);
                    const resultadoExtras = sortearEntreTimesComLimite(jogadoresExtras, faltamA, faltamB);
                    peladaMatch.teamA.push(...resultadoExtras.paraTimeA);
                    peladaMatch.teamB.push(...resultadoExtras.paraTimeB);
                    peladaQueue.value = peladaQueue.value.slice(jogadoresExtras.length);
                }
                
                peladaStatus.teamsGenerated = true;
                resetPeladaTimer(true);
                peladaUI.showRegister = false;
                savePeladaData();
            };
            
            const togglePeladaTimer = () => {
                peladaMatch.timerRunning = !peladaMatch.timerRunning;
                if (peladaMatch.timerRunning) {
                    peladaMatch.hasStarted = true;
                    peladaTimerInterval = setInterval(() => {
                        if (peladaMatch.timeLeft > 0) {
                            peladaMatch.timeLeft--;
                            savePeladaData();
                        } else {
                            peladaMatch.timerRunning = false;
                            clearInterval(peladaTimerInterval);
                            peladaMatch.teamA.forEach(p => p.matchesPlayed = (p.matchesPlayed || 0) + 1);
                            peladaMatch.teamB.forEach(p => p.matchesPlayed = (p.matchesPlayed || 0) + 1);
                            if (peladaMatch.scoreA > peladaMatch.scoreB) {
                                peladaMatch.lastWinner = 'A';
                            } else if (peladaMatch.scoreB > peladaMatch.scoreA) {
                                peladaMatch.lastWinner = 'B';
                            } else {
                                peladaMatch.lastWinner = null;
                            }
                            savePeladaData();
                            alert("Fim de Jogo!");
                        }
                    }, 1000);
                } else {
                    clearInterval(peladaTimerInterval);
                    savePeladaData();
                }
            };
            
            const resetPeladaTimer = (isFirst) => {
                clearInterval(peladaTimerInterval);
                peladaMatch.timerRunning = false;
                peladaMatch.hasStarted = false;
                peladaStatus.isFirstMatch = isFirst;
                peladaMatch.timeLeft = (isFirst ? peladaConfig.timeFirstMatch : peladaConfig.timeNormalMatch) * 60;
                peladaMatch.scoreA = 0;
                peladaMatch.scoreB = 0;
                savePeladaData();
            };
            
            const adjustPeladaTime = (seconds) => {
                peladaMatch.timeLeft = Math.max(0, peladaMatch.timeLeft + seconds);
                savePeladaData();
            };
            
            const setPeladaTimeZero = () => {
                peladaMatch.timeLeft = 0;
                savePeladaData();
            };
            
            const adjustPeladaScore = (team, delta) => {
                if (team === 'A') peladaMatch.scoreA = Math.max(0, peladaMatch.scoreA + delta);
                else peladaMatch.scoreB = Math.max(0, peladaMatch.scoreB + delta);
                savePeladaData();
            };
            
            const nextPeladaMatch = () => {
                let winner = null;
                if (peladaMatch.scoreA > peladaMatch.scoreB) {
                    winner = 'A';
                } else if (peladaMatch.scoreB > peladaMatch.scoreA) {
                    winner = 'B';
                } else {
                    winner = 'DRAW';
                }

                if (winner === 'DRAW') {
                    peladaMatch.lastWinner = null;
                } else {
                    peladaMatch.lastWinner = winner;
                }

                const replaceLinePlayers = (team) => {
                    const gk = team.filter(p => p.role === 'GK');
                    const linePlayers = team.filter(p => p.role !== 'GK');
                    linePlayers.forEach(p => peladaQueue.value.push(p));
                    const newLinePlayers = peladaQueue.value.splice(0, 4);
                    return [...gk, ...newLinePlayers];
                };

                const replaceLosingTeam = (team) => {
                    const currentGk = team.find(p => p.role === 'GK');
                    const linePlayers = team.filter(p => p.role !== 'GK');
                    linePlayers.forEach(p => peladaQueue.value.push(p));
                    const newLinePlayers = peladaQueue.value.splice(0, 4);
                    
                    let newGk = [];
                    if (peladaGoalkeeperQueue.value.length > 0) {
                        const nextGk = peladaGoalkeeperQueue.value.shift();
                        newGk = [nextGk];
                        if (currentGk) {
                            peladaGoalkeeperQueue.value.push(currentGk);
                        }
                    } else {
                        newGk = currentGk ? [currentGk] : [];
                    }
                    
                    return [...newGk, ...newLinePlayers];
                };

                if (winner === 'A') {
                    peladaMatch.teamB = replaceLosingTeam(peladaMatch.teamB);
                } else if (winner === 'B') {
                    peladaMatch.teamA = replaceLosingTeam(peladaMatch.teamA);
                } else {
                    const availableGks = peladaGoalkeeperQueue.value.length;
                    if (availableGks >= 2) {
                        peladaMatch.teamA = replaceLosingTeam(peladaMatch.teamA);
                        peladaMatch.teamB = replaceLosingTeam(peladaMatch.teamB);
                    } else if (availableGks === 1) {
                        peladaMatch.teamA = replaceLosingTeam(peladaMatch.teamA);
                        peladaMatch.teamB = replaceLinePlayers(peladaMatch.teamB);
                    } else {
                        peladaMatch.teamA = replaceLinePlayers(peladaMatch.teamA);
                        peladaMatch.teamB = replaceLinePlayers(peladaMatch.teamB);
                    }
                }
                
                resetPeladaTimer(false);
                savePeladaData();
            };
            
            const rotatePeladaTeams = () => {
                if (!confirm("Rotacionar times? Os prÃ³ximos jogadores da fila entrarÃ£o em campo.")) return;
                
                const gkTeamA = peladaMatch.teamA.filter(p => p.role === 'GK');
                const gkTeamB = peladaMatch.teamB.filter(p => p.role === 'GK');
                
                const linePlayersTeamA = peladaMatch.teamA.filter(p => p.role !== 'GK');
                const linePlayersTeamB = peladaMatch.teamB.filter(p => p.role !== 'GK');
                linePlayersTeamA.forEach(p => peladaQueue.value.push(p));
                linePlayersTeamB.forEach(p => peladaQueue.value.push(p));
                
                const linePlayersNeeded = 4;
                const newLinePlayersA = peladaQueue.value.splice(0, linePlayersNeeded);
                const newLinePlayersB = peladaQueue.value.splice(0, linePlayersNeeded);
                
                peladaMatch.teamA = [...gkTeamA, ...newLinePlayersA];
                peladaMatch.teamB = [...gkTeamB, ...newLinePlayersB];
                
                resetPeladaTimer(false);
                savePeladaData();
            };
            
            const clearPeladaTeams = () => {
                if (!confirm("Limpar tÃ¡bua? Todos os jogadores serÃ£o removidos dos times.")) return;
                
                peladaMatch.teamA.forEach(p => {
                    if (p.role === 'GK') peladaGoalkeeperQueue.value.push(p);
                    else peladaQueue.value.push(p);
                });
                peladaMatch.teamB.forEach(p => {
                    if (p.role === 'GK') peladaGoalkeeperQueue.value.push(p);
                    else peladaQueue.value.push(p);
                });
                
                peladaMatch.teamA = [];
                peladaMatch.teamB = [];
                savePeladaData();
            };
            
            const onPeladaDragStart = (evt, player, listName) => {
                peladaDraggedItem = player;
                peladaSourceList = listName;
                evt.dataTransfer.effectAllowed = 'move';
            };

            const onPeladaDrop = (evt, targetList) => {
                if (!peladaDraggedItem || peladaSourceList === targetList) return;

                if (peladaSourceList === 'register') {
                    if (targetList === 'queue') {
                        let warnings = [];
                        if (!peladaDraggedItem.paid) warnings.push("âš ï¸ Este jogador ainda NÃƒO PAGOU!");
                        if (!peladaDraggedItem.arrived) warnings.push("âš ï¸ Este jogador ainda NÃƒO CHEGOU!");
                        if (warnings.length > 0) alert(warnings.join("\n"));
                        
                        if (!peladaQueue.value.find(q => q.id === peladaDraggedItem.id)) {
                            peladaQueue.value.push({ ...peladaDraggedItem });
                        }
                        peladaAllPlayers.value = peladaAllPlayers.value.filter(p => p.id !== peladaDraggedItem.id);
                    }
                    peladaDraggedItem = null;
                    peladaSourceList = null;
                    savePeladaData();
                    return;
                }

                const removeFromList = (listName) => {
                    if (listName === 'teamA') peladaMatch.teamA = peladaMatch.teamA.filter(p => p.id !== peladaDraggedItem.id);
                    else if (listName === 'teamB') peladaMatch.teamB = peladaMatch.teamB.filter(p => p.id !== peladaDraggedItem.id);
                    else if (listName === 'queue') peladaQueue.value = peladaQueue.value.filter(p => p.id !== peladaDraggedItem.id);
                    else if (listName === 'goalkeeperQueue') peladaGoalkeeperQueue.value = peladaGoalkeeperQueue.value.filter(p => p.id !== peladaDraggedItem.id);
                };
                removeFromList(peladaSourceList);
                
                if (targetList === 'queue') peladaQueue.value.push(peladaDraggedItem);
                else if (targetList === 'teamA') peladaMatch.teamA.push(peladaDraggedItem);
                else if (targetList === 'teamB') peladaMatch.teamB.push(peladaDraggedItem);
                else if (targetList === 'goalkeeperQueue') peladaGoalkeeperQueue.value.push(peladaDraggedItem);
                
                peladaDraggedItem = null;
                savePeladaData();
            };
            
            const onDropOnPeladaQueueCard = (targetPlayerId) => {
                if (!peladaDraggedItem) return;
                
                if (peladaSourceList === 'queue') {
                    const fromIndex = peladaQueue.value.findIndex(p => p.id === peladaDraggedItem.id);
                    const toIndex = peladaQueue.value.findIndex(p => p.id === targetPlayerId);
                    
                    if (fromIndex > -1 && toIndex > -1) {
                        const [movedPlayer] = peladaQueue.value.splice(fromIndex, 1);
                        peladaQueue.value.splice(toIndex, 0, movedPlayer);
                    }
                } else {
                    if (peladaSourceList === 'teamA') peladaMatch.teamA = peladaMatch.teamA.filter(p => p.id !== peladaDraggedItem.id);
                    else if (peladaSourceList === 'teamB') peladaMatch.teamB = peladaMatch.teamB.filter(p => p.id !== peladaDraggedItem.id);
                    
                    const toIndex = peladaQueue.value.findIndex(p => p.id === targetPlayerId);
                    if (toIndex > -1) {
                        peladaQueue.value.splice(toIndex, 0, peladaDraggedItem);
                    } else {
                        peladaQueue.value.push(peladaDraggedItem);
                    }
                }
                
                peladaDraggedItem = null;
                peladaSourceList = null;
                savePeladaData();
            };
            
            // ==================== LIFECYCLE ====================
            onMounted(async () => {
                // Verificar sessÃ£o existente
                const { data: { session: existingSession } } = await supabaseClient.auth.getSession();
                if (existingSession) {
                    session.value = existingSession;
                    await bootstrapProfile(existingSession.user);
                    loadGroups();
                }
                
                // Listener de mudanÃ§a de auth
                supabaseClient.auth.onAuthStateChange(async (event, newSession) => {
                    session.value = newSession;
                    if (newSession) {
                        await bootstrapProfile(newSession.user);
                        loadGroups();
                    } else {
                        userProfile.value = null;
                        currentView.value = 'grupos';
                    }
                });
            });

            return {
                // Auth
                session, userProfile, authMode, authForm, authError, authSuccess, authLoading,
                handleAuth, handleLogout,
                
                // Navigation
                currentView, sidebarExpanded, navigateTo,
                
                // Groups
                loadingGroups, pendingInvites, adminGroups, memberGroups,
                showCreateGroupModal, createGroupForm, createGroupError, creatingGroup,
                openCreateGroupModal, createGroup, acceptInvite, declineInvite,
                
                // Members Modal
                showMembersModal, selectedGroupForMembers, loadingMembers,
                pendingMembers, activeMembers, inviteEmail, inviteAsAdmin,
                invitingPlayer, inviteError, inviteSuccess,
                openMembersModal, invitePlayer, cancelInvite,
                promoteToAdmin, demoteFromAdmin, removeMember,
                
                // Profile
                profileForm, profileError, profileSuccess, savingProfile, saveProfile,
                
                // Pelada
                currentGroupId, currentGroupName,
                peladaConfig, peladaStatus, peladaUI, peladaInput,
                peladaAllPlayers, peladaMatch, peladaQueue, peladaGoalkeeperQueue,
                peladaFormattedTime, peladaPaidCount, peladaArrivedCount,
                openPelada, resetPelada,
                addPeladaPlayers, markAllPeladaPaid, markAllPeladaArrivedAndQueue,
                onPeladaArrivedChange, onPeladaPaidChange,
                onPeladaDragStartFromRegister, onDropOnPeladaRegister,
                removeFromPeladaQueue, movePeladaPlayerUp, movePeladaPlayerDown,
                removeFromPeladaGoalkeeperQueue, movePeladaGoalkeeperUp, movePeladaGoalkeeperDown,
                onDropOnPeladaGoalkeeperCard,
                generatePeladaInitialTeams, togglePeladaTimer, resetPeladaTimer,
                adjustPeladaTime, setPeladaTimeZero, adjustPeladaScore,
                nextPeladaMatch, rotatePeladaTeams, clearPeladaTeams,
                onPeladaDragStart, onPeladaDrop, onDropOnPeladaQueueCard,
                savePeladaData
            };
        }
    });

    // Componente Player Card para Pelada
    app.component('pelada-player-card', {
        props: ['player', 'index', 'mini', 'showRemove', 'showReorder', 'isFirst', 'isLast'],
        template: '#pelada-player-card-template',
        data() { return { isDragOver: false } },
        methods: {
            onDragOver() { this.isDragOver = true; },
            onDrop(event) {
                this.isDragOver = false;
                this.$emit('drop-on-card', this.player.id);
            }
        }
    });

    app.mount('#app');
</script>
</body>
</html>
